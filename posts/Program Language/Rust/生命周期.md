---
title: '生命周期'
date: 2025-08-15  
author: 'CK'
tags: ['Study','Note']
---

Rust 生命周期笔记

---

## 1. 隐式生命周期
<!-- TODO: 完善该部分 -->

## 2. 显式生命周期
### 2.1 函数显式声明生命周期
编译器无法推导出返回值的生命周期时，需要通过`'`开头的名称，显式标注一个生命周期。
例如，下面函数返回的引用可能为`x`和`y`，编译器无法确定返回引用具体生命周期是`x`还是`y`，因此需要显式指定一个生命周期`'a`：
``` Rust
fn longest<'a>(x: &'a str, y: &'a str) -> &'a str {
    if x.len() > y.len() {
        x
    } else {
        y
    }
}
```
其表示返回的引用生命周期为`'a`，而参数`x`和`y`都标记了生命周期`'a`，因此返回引用要活着至少得保证x和y都活着，也就是返回引用的生命周期与`x`和`y`较小的一致。例如：
``` Rust
fn main() {
    let string1 = String::from("long string is long");

    {
        let string2 = String::from("xyz");
        let result = longest(string1.as_str(), string2.as_str());
        println!("The longest string is {}", result);
    }// string2和result生命周期在此结束
}// string1生命周期在此结束
```
此时`result`生命周期与`string2`一致，因为`string2`生命周期小于`string1`。
### 2.2 结构体显式声明生命周期
当结构体属性出现引用类型时使用
``` Rust
struct ImportantExcerpt<'a> {
    part: &'a str,
}

fn main() {
    let novel = String::from("Call me Ishmael. Some years ago...");
    let first_sentence = novel.split('.').next().expect("Could not find a '.'");
    let i = ImportantExcerpt {
        part: first_sentence,
    };
}
```
结构体对象的生命周期需要小于等于其内部引用的生命周期。

### 2.3 生命周期的消除规则
- 输入生命周期：每一个引用参数都会获得独自的生命周期。
- 输出生命周期：
  1. 若只有一个输入生命周期（函数参数中只有一个引用类型），那么该生命周期会被赋给所有的输出生命周期，也就是所有返回值的生命周期都等于该输入生命周期；
  2. 若存在多个输入生命周期，且其中一个是 `&self` 或 `&mut self`，则 `&self` 的生命周期被赋给所有的输出生命周期。

### 2.4 方法的生命周期
根据消除规则，默认情况：
``` Rust
impl<'a> ImportantExcerpt<'a> {
    fn announce_and_return_part<'b>(&'a self, announcement: &'b str) -> &'a str {
        println!("Attention please: {}", announcement);
        self.part
    }
}
```
如果需要单独指定返回值的生命周期为`'b`，则需要添加约束，要求生命周期`'b`比`'a`短：
``` Rust
impl<'a: 'b, 'b> ImportantExcerpt<'a> {
    fn announce_and_return_part(&'a self, announcement: &'b str) -> &'b str {
        println!("Attention please: {}", announcement);
        self.part
    }
}

// 或者使用where
impl<'a> ImportantExcerpt<'a> {
    fn announce_and_return_part<'b>(&'a self, announcement: &'b str) -> &'b str
    where
        'a: 'b,
    {
        println!("Attention please: {}", announcement);
        self.part
    }
}
```
### 2.5 静态生命周期
`'static`声明生命周期和程序活得一样久。